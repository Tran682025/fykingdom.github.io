<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PiChordify Kingdom ‚Äî v0.3k</title>
  <style>
    :root{--pi:#6d4bff;--ink:#222;--bg:#f7f7ff}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 18px}
    h1{margin:0;font-size:28px;color:var(--pi);font-weight:800}
    .badge{background:#efe9ff;color:#5522ff;border-radius:16px;padding:6px 12px;font-weight:700}
    main{max-width:1080px;margin:0 auto;padding:0 12px 48px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input[type="text"], textarea{width:100%;min-height:48px;padding:10px 12px;border:1px solid #bbb;border-radius:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:0;border-radius:12px;padding:11px 14px;font-weight:700}
    .primary{background:var(--pi);color:#fff}
    .ghost{background:#efeafe;color:#361cc9}
    .warn{background:#ffe9e9;color:#b01b1b}
    .muted{color:#666}
    .status{min-height:180px;white-space:pre-wrap;background:#111;color:#fff;border-radius:12px;padding:12px;border:1px dashed #7c7cff}
    .kara{min-height:260px;border:1px dashed #ddd;border-radius:12px;padding:12px}
    footer{padding:26px 12px;text-align:center;color:#777}
    @media (max-width:780px){.grid{grid-template-columns:1fr}}
  </style>

  <!-- Pi SDK: ch·ªâ ho·∫°t ƒë·ªông trong Pi Browser -->
  <script src="https://sdk.minepi.com/pi-sdk-js/2.6.0/pi-sdk.min.js" defer></script>

  <!-- Backend URL (ƒë·ªïi n·∫øu c·∫ßn) -->
  <script>
    window.BACKEND_BASE = "https://pichordifykingdom-backend.onrender.com";
  </script>
</head>
<body>
  <header>
    <div style="display:flex;gap:10px;align-items:center">
      <h1>PiChordify Kingdom</h1>
      <span class="badge" id="tier">Free</span>
    </div>
    <div class="row">
      <button class="ghost" id="btnCheckPremium">Ki·ªÉm tra Premium</button>
      <button class="primary" id="btnPayPremium">Thanh to√°n Premium</button>
    </div>
  </header>

  <main>
    <section class="grid">
      <div class="card">
        <div class="muted" style="margin-bottom:8px">Demo Core v0.3k</div>
        <div class="row">
          <button class="ghost" id="btnLoadDemo1">T·∫£i demo 1</button>
          <button class="ghost" id="btnLoadDemo2">T·∫£i demo 2</button>
          <button class="ghost warn" id="btnClear">X√≥a</button>
        </div>

        <label for="title">Ti√™u ƒë·ªÅ</label>
        <input id="title" type="text" placeholder="T√™n b√†i‚Ä¶" value="T√¨nh N·ªìng Vi·ªát"/>

        <label for="lyrics" style="margin-top:12px">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian)</label>
        <textarea id="lyrics" placeholder="mm:ss   n·ªôi dung / h·ª£p √¢m"></textarea>

        <div class="row" style="margin-top:14px">
          <button class="primary" id="btnCompile">Bi√™n d·ªãch & xem tr∆∞·ªõc</button>
          <button class="ghost" id="btnExportSrt">Export .srt</button>
          <button class="primary" id="btnExportPDF">Export PDF (Premium)</button>
        </div>

        <label for="bpm" style="margin-top:14px">BPM (nh·ªãp)</label>
        <input id="bpm" type="text" value="80" />
        <label for="offset" style="margin-top:8px">Offset (gi√¢y, +/-)</label>
        <input id="offset" type="text" value="0" />
      </div>

      <div class="card">
        <h2 style="margin-top:0">Tr·∫°ng th√°i</h2>
        <div id="status" class="status">ƒêang kh·ªüi t·∫°o‚Ä¶</div>

        <h2>Xem tr∆∞·ªõc Karaoke/Chord</h2>
        <div id="preview" class="kara"></div>

        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnPlay">‚ñ∂ Play</button>
          <button class="ghost" id="btnStop">‚ñ† Stop</button>
        </div>

        <div class="muted" style="margin-top:10px">00:00</div>
      </div>
    </section>
  </main>

  <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v0.3k</footer>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const status = (t)=>{ const el=$("#status"); el.textContent = (el.textContent?el.textContent+"\n":"")+t };

    document.addEventListener("DOMContentLoaded", ()=>{
      status("‚úÖ DOM loaded. JS ƒëang ch·∫°y.");

      // ·∫®n n√∫t thanh to√°n n·∫øu kh√¥ng ·ªü Pi Browser
      const inPi = typeof window.Pi !== "undefined";
      if(!inPi){ $("#btnPayPremium").style.display="none"; status("‚ÑπÔ∏è Kh√¥ng ·ªü Pi Browser ‚Üí ·∫©n thanh to√°n. V√†o Pi Browser ƒë·ªÉ test SDK."); }
      else { status("üü£ Ph√°t hi·ªán Pi SDK."); }

      // D·ªØ li·ªáu demo
      const demo1 = `00:00 Am\n00:05 F\n00:10 C\n00:15 G\n00:20 Dm\n00:25 E\n00:30 Am`;
      const demo2 = `00:00 C\n00:05 G\n00:10 Am\n00:15 F\n00:20 C\n00:25 G\n00:30 C`;
      $("#lyrics").value = demo1;

      // Bi√™n d·ªãch (gi·∫£n l∆∞·ª£c ‚Äì render ch·ªØ)
      $("#btnCompile").addEventListener("click", ()=>{
        const txt = $("#lyrics").value.trim();
        const box = $("#preview"); box.innerHTML="";
        txt.split("\n").forEach(line=>{
          const p=document.createElement("div");
          p.textContent=line;
          box.appendChild(p);
        });
        status("üß© ƒê√£ bi√™n d·ªãch & hi·ªÉn th·ªã xem tr∆∞·ªõc.");
      });

      // T·∫£i demo
      $("#btnLoadDemo1").addEventListener("click", ()=>{ $("#lyrics").value=demo1; status("üìÑ ƒê√£ n·∫°p Demo 1"); });
      $("#btnLoadDemo2").addEventListener("click", ()=>{ $("#lyrics").value=demo2; status("üìÑ ƒê√£ n·∫°p Demo 2"); });
      $("#btnClear").addEventListener("click", ()=>{ $("#lyrics").value=""; $("#preview").innerHTML=""; status("üßπ ƒê√£ x√≥a"); });

      // WebAudio: metronome test (ƒë·∫£m b·∫£o c√≥ √¢m thanh khi b·∫•m Play)
      let ctx, osc, gain;
      function ensureAudio(){
        if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)(); }
        if(ctx.state==="suspended"){ ctx.resume(); }
      }
      $("#btnPlay").addEventListener("click", ()=>{
        ensureAudio();
        const bpm = parseInt($("#bpm").value||"80",10);
        const tickHz = 880;
        const dur = 0.06; // 60ms/tick
        const interval = 60/bpm;
        let count = 0;
        osc = ctx.createOscillator(); gain = ctx.createGain();
        osc.type = "sine"; osc.frequency.value = tickHz;
        gain.gain.value = 0; osc.connect(gain); gain.connect(ctx.destination); osc.start();

        // ph√°t 16 nh·ªãp l√†m v√≠ d·ª•
        const start = ctx.currentTime;
        for(let i=0;i<16;i++){
          const t = start + i*interval;
          gain.gain.setValueAtTime(0.0, t);
          gain.gain.linearRampToValueAtTime(0.8, t+0.005);
          gain.gain.exponentialRampToValueAtTime(0.001, t+dur);
        }
        status(`üîä Play metronome 16 nh·ªãp @ ${bpm} BPM`);
      });
      $("#btnStop").addEventListener("click", ()=>{
        try{ osc && osc.stop(); osc=null; }catch{}
        status("‚èπÔ∏è Stop");
      });

      // Export .srt (mock)
      $("#btnExportSrt").addEventListener("click", ()=>{
        const blob = new Blob([$("#lyrics").value], {type:"text/plain"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "lyrics.srt";
        a.click();
        status("üíæ ƒê√£ xu·∫•t .srt (demo).");
      });

      // Export PDF: y√™u c·∫ßu Premium (g·ªçi backend)
      $("#btnExportPDF").addEventListener("click", async ()=>{
        status("üì° Y√™u c·∫ßu backend t·∫°o PDF‚Ä¶");
        try{
          const res = await fetch(`${window.BACKEND_BASE}/api/export/pdf`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ title: $("#title").value, lyrics: $("#lyrics").value })
          });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const { url } = await res.json();
          window.open(url, "_blank");
          status("‚úÖ PDF s·∫µn s√†ng.");
        }catch(e){ status("‚ùå L·ªói export PDF (demo/fallback)."); }
      });

      // Ki·ªÉm tra/Thanh to√°n Premium (mock ƒë·ªÉ kh√¥ng b·ªã ƒë·ª©ng khi kh√¥ng ·ªü Pi)
      $("#btnCheckPremium").addEventListener("click", async ()=>{
        try{
          const res = await fetch(`${window.BACKEND_BASE}/api/premium/check`, {method:"POST"});
          const { premium=false } = await res.json().catch(()=>({premium:false}));
          $("#tier").textContent = premium ? "Premium" : "Free";
          status(`üîç Premium: ${premium}`);
        }catch{ status("‚ö†Ô∏è Kh√¥ng g·ªçi ƒë∆∞·ª£c backend /check."); }
      });

      $("#btnPayPremium").addEventListener("click", async ()=>{
        if(!inPi){ status("‚ö†Ô∏è Vui l√≤ng m·ªü b·∫±ng Pi Browser ƒë·ªÉ thanh to√°n."); return; }
        try{
          // v√≠ d·ª• payload t·ªëi gi·∫£n ‚Äì ph·∫ßn th·∫≠t ·ªü backend
          const res = await fetch(`${window.BACKEND_BASE}/api/premium/pay`, {method:"POST"});
          const j = await res.json();
          status("ü™ô ƒê√£ g·ªçi /pay, ki·ªÉm tra v√≠ trong Pi.");
        }catch{ status("‚ùå Kh√¥ng g·ªçi ƒë∆∞·ª£c backend /pay."); }
      });

      status("‚ù§Ô∏è Ready.");
    });
  })();
  </script>
</body>
</html>
